# =============================================================================
# Nginx Auto Scaling Group ë°°í¬ íŒŒì´í”„ë¼ì¸
# =============================================================================
# ëª©ì : nginx ë””ë ‰í† ë¦¬ì˜ ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ì—¬ ECRì— Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œ/í‘¸ì‹œí•˜ê³ ,
#      ASGì˜ ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤ì— ìë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.
#
# íŠ¸ë¦¬ê±°: ci/asg ë¸Œëœì¹˜ì˜ nginx/** ê²½ë¡œì— push ë˜ëŠ” PR ìƒì„± ì‹œ ì‹¤í–‰
# ë°°í¬ ëŒ€ìƒ: ASG_TAG_KEY=ASG_TAG_VALUE íƒœê·¸ë¥¼ ê°€ì§„ ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤
# =============================================================================

name: Nginx-ASG-Pipeline

on:
  push:
    branches: ["main"]
    paths:
      - "nginx/**" # nginx ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œë§Œ ì‹¤í–‰
  pull_request:
    branches: ["main"]
    paths:
      - "nginx/**"
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read

jobs:
  # =============================================================================
  # Job: ë¹Œë“œ ë° ë°°í¬
  # =============================================================================
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------------------
      # Step 1: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # -------------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # Step 2: AWS ìê²© ì¦ëª… ì„¤ì •
      # -------------------------------------------------------------------------
      # í•„ìš”í•œ Secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -------------------------------------------------------------------------
      # Step 3: Amazon ECR ë¡œê·¸ì¸
      # -------------------------------------------------------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # -------------------------------------------------------------------------
      # Step 4: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRì— í‘¸ì‹œ
      # -------------------------------------------------------------------------
      # ì´ë¯¸ì§€ íƒœê·¸: ì»¤ë°‹ í•´ì‹œ(ê³ ìœ ) + latest
      # ì´ë¯¸ì§€ì— í¬í•¨: nginx.conf, default.conf, index.html ë“± ëª¨ë“  ì •ì  íŒŒì¼
      - name: Build and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Dockerfileì´ ì–´ë”” ìˆëŠ”ì§€ ì°¾ì•„ì„œ ë³€ìˆ˜ì— ë„£ìŒ (ê°œê¿€íŒ)
          DOCKERFILE_PATH=$(find . -name Dockerfile | head -n 1)
          BUILD_CONTEXT=$(dirname $DOCKERFILE_PATH)
          
          echo "Found Dockerfile at: $DOCKERFILE_PATH"
          echo "Building context: $BUILD_CONTEXT"

          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                       -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                       $BUILD_CONTEXT
                       
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest



      # -------------------------------------------------------------------------
      # Step 5: SSMì„ í†µí•´ ASGì˜ ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤ì— ë°°í¬
      # -------------------------------------------------------------------------
      # í•„ìš”í•œ Secrets: ASG_TAG_KEY, ASG_TAG_VALUE
      # ì˜ˆ: ASG_TAG_KEY=Name, ASG_TAG_VALUE=sonic-nginx-asg
      #
      # ë™ì‘ ê³¼ì •:
      # 1) íŠ¹ì • íƒœê·¸ë¥¼ ê°€ì§„ ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëŒ€ìƒìœ¼ë¡œ SSM ëª…ë ¹ ì „ì†¡
      # 2) ê° EC2ì—ì„œ ECR ë¡œê·¸ì¸ â†’ ì´ë¯¸ì§€ pull â†’ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      # 3) (ì¤‘ìš”) ëª…ë ¹ ì „ì†¡ í›„ ì¦‰ì‹œ ì¢…ë£Œ (ë¹„ë™ê¸° ì‹¤í–‰)
      - name: Deploy to ASG via SSM
        run: |
          # ë°°í¬í•  ì´ë¯¸ì§€ ì •ë³´
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          REPO="${{ secrets.ECR_REPOSITORY }}"
          TAG="${{ github.sha }}"
          FULL_IMAGE="$REGISTRY/$REPO:$TAG"

          # SSM ëª…ë ¹ ì „ì†¡ (íŠ¹ì • íƒœê·¸ë¥¼ ê°€ì§„ ëª¨ë“  EC2 ëŒ€ìƒ)
          # ì£¼ì˜: JSON íŒŒë¼ë¯¸í„° ë‚´ì˜ ë”°ì˜´í‘œëŠ” ì´ìŠ¤ì¼€ì´í”„(\") ì²˜ë¦¬ í•„ìˆ˜
          COMMAND_ID=$(aws ssm send-command \
            --targets "Key=tag:${{ secrets.ASG_TAG_KEY }},Values=${{ secrets.ASG_TAG_VALUE }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying Nginx via GitHub Actions" \
            --region ${{ secrets.AWS_REGION }} \
            --parameters "{
              \"commands\": [
                \"# ECR ë¡œê·¸ì¸\",
                \"aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin $REGISTRY\",

                \"# ìƒˆ ì´ë¯¸ì§€ pull\",
                \"sudo docker pull $FULL_IMAGE\",

                \"# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ (ì—ëŸ¬ ë¬´ì‹œ)\",
                \"sudo docker stop nginx-server || true\",
                \"sudo docker rm nginx-server || true\",

                \"# ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰\",
                \"sudo docker run -d --name nginx-server -p 80:80 $FULL_IMAGE\",

                \"# ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì •ë¦¬\",
                \"sudo docker image prune -f\"
              ]
            }" \
            --query 'Command.CommandId' \
            --output text)

          echo "âœ… ë°°í¬ ëª…ë ¹(SSM) ì „ì†¡ ì™„ë£Œ! Command ID: $COMMAND_ID"
          echo "ğŸš€ ê° EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë°±ê·¸ë¼ìš´ë“œë¡œ ë°°í¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤. (GitHub Actions ì¢…ë£Œ)"
